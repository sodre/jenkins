# nginx configuration for reverse proxying local Jenkins server,
# with Let's Encrypt protection.
{{ $backend := env "BACKEND" }}
{{ $acme_domain := env "ACME_DOMAIN" }}
{{ $ssl_ready := env "SSL_READY" }}

{{ if service $backend }}
upstream jenkins {
    {{ range service $backend }}
    server {{.Address}}:50000;
    {{end}}
    least_conn;
}


{{ if eq $ssl_ready "true" }}
limit_conn_zone $binary_remote_addr zone=addr:1m;

server {
    listen       50000;
    #include /etc/nginx/ssl.conf;

    # Limits number of connection to 1 per IP address
    # This prevents any new connections being made to this port from
    # within the Slave nodes
    # This would work, but the Slaves are connecting through NAT
    # limit_conn addr 1;

    proxy_pass      jenkins;
}
{{ end }}
{{ end }}
